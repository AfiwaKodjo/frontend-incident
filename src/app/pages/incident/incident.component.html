<section class="section dashboard">
  <div class="row">

    <!-- Left side columns -->
    <div class="col-lg-12">
      <div class="row">
        <div class="pagetitle">
          <h1>Incident</h1>
          <br>
          <nav>
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="index.html">Accueil</a></li>
              <li class="breadcrumb-item active">Incident</li>
            </ol>
          </nav>
        </div>
      </div>          
    </div>
  </div>
</section>


<div class="row">
    <div class="col-12 col-lg-3 mb-3">
        <div class="text-center px-xl-3">
          <button class="btn btn-success btn-block" type="button" data-toggle="modal" data-target="#user-form-modal2" >Nouvel incident</button>
        </div>
    </div>

    <!--div class="col-lg-2  mb-3 d-flex justify-content-end ms-auto">
      <input class="form-control w-100" (ngModelChange)="searchIncidents(key.value )" #key="ngModel" ngModel
       type="search" placeholder=" FILTRE..."  id="searchNom" name="key"  required>
    </div--> 

    <div class="col-lg-2 mb-3 d-flex justify-content-end ms-auto">
      <div class="input-group">
          <input class="form-control" (ngModelChange)="searchIncidents(key.value)" #key="ngModel" ngModel
                 type="search" placeholder="FILTRE..." id="searchNom" name="key">
          <div class="input-group-append">
              <span class="input-group-text">
                  <i class="fa fa-filter"></i>
              </span>
          </div>
      </div>
  </div>
  
    </div>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
<div class="container mt-3" id="main-container">
    <h2>Liste des incidents</h2>  
    <button class="btn btn-primary" (click)="generatePDF()">Générer PDF</button>     
    <table class="custom-table">
      <thead>
        <tr>
          <th>Nom</th>
          <!--th>Description</th-->
          <th>Canal de l'incident</th>
          <th>Priorité</th>
          <th>Client</th>
          <th>Agence</th>
          <th>téléphone</th>
          <!--th>procédure</th>
          <th>Libellé</th-->
          <th>Statut de l'incident</th>
          <th>Date de création</th>
          <th>Date de clôture</th>
          <th>Technicien</th>
          <th>Vos actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let incident of incidents" [class.unclosed-incident]="!incident.dateClotureIncident">
          <td>{{incident.nomIncident}}</td>
          <!--td>{{incident.descriptionIncident}}</td-->
          <td>{{incident.canalIncident}}</td>
          <td style="color: green;"><b>{{incident.prioriteIncident}}</b></td>
          <td>{{incident.agence.client.nomClient}}</td>
          <td>{{incident.agence.lieuAgence}}</td>
          <td>{{incident.agence.telephoneAgence}}</td>
          <!--td>{{incident.procedure.nomProcedure}}</td>
          <td>{{incident.procedure.libelleProcedure}}</td-->
          <td style="color: black;"><b>{{incident.statutIncident}}</b></td>
          <td>{{incident.dateCreationIncident}}</td>
          <td>{{incident.dateClotureIncident}}</td>
          <td><b>{{incident.agence.client.utilisateur.nom}}</b></td>
            <!--td>
            <button type="button" class="btn btn-outline-info btn-circle btn-lg btn-circle ml-0" (click)="updateIncident(incident.idIncident)"><i class="fa fa-edit" style="color:royalblue;"></i> </button>
            <button type="button" class="btn btn-outline-info btn-circle btn-lg btn-circle ml-0" (click)="onOpenModal(incident,'delete')" data-placement="top" data-toggle="tooltip" data-original-title="Delete"><i class="fa fa-trash" style="color: red;"></i> </button>
            <button type="button" class="btn btn-outline-info btn-circle btn-lg btn-circle ml-0" (click)="incidentDetails(incident.idIncident)"><i class="fa fa-plus" style="color: green;"></i> </button>
            <button class="btn btn-primary ms-auto me-1" (click)="assignPriority(incident.idIncident)"><i class="bi bi-mailbox"></i> Mail</button>
        
          </td-->
        
          <td>
            <div class="btn-group btn-group-horizontal" role="group" aria-label="Boutons d'action">
              <button type="button" class="btn btn-outline-info btn-sm btn-circle" (click)="updateIncident(incident.idIncident)">
                <i class="fa fa-edit" style="color: royalblue;"></i>
              </button>
              <button type="button" class="btn btn-outline-info btn-sm btn-circle" (click)="onOpenModal(incident,'delete')" data-placement="top" data-toggle="tooltip" data-original-title="Delete">
                <i class="fa fa-trash" style="color: red;"></i>
              </button>
              <button type="button" class="btn btn-outline-info btn-sm btn-circle" (click)="incidentDetails(incident.idIncident)">
                <i class="bi bi-eye-fill" style="color: green;"></i>
              </button>
              <!--button type="button" class="btn btn-primary btn-sm btn-circle ms-auto" (click)="assignPriority(incident.idIncident)">
                <i class="bi bi-mailbox"></i> Mail
              </button-->
            </div>
          </td>
    
        </tr>
      </tbody>
    </table>
  </div>


  <div class="modal fade" role="dialog" tabindex="-1" id="user-form-modal2">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ajout d'incident</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="py-1">
            <form class="form"  (ngSubmit)="onSubmit()">
              <div class="row">
                <div class="col">
                  <div class="row">
                    <div class="col">
                    <!--div class="form-group">
                        <label>Insérez un chiffre</label>
                        <input class="form-control" type="number" name="idIncident" id="idIncident" min="1" placeholder="Chiffre" [(ngModel)]="incident.idIncident">
                    </div-->
                    <!--br-->
                      <div class="form-group">
                        <label>Nom de l'incident</label>
                        <input class="form-control" type="text" name="nomIncident" placeholder="Nom incident" id="nomIncident" [(ngModel)]="incident.nomIncident">
                      </div>
                      <br>
                      <div class="form-group">
                      <label for="procedure" >Canal de l'incident</label>
                      <select [(ngModel)]="incident.canalIncident"  class="form-select" name="canalIncident">
                        <option [ngValue]="undefined">--Sélectionnez un canal--</option>
                        <option>Mail</option>
                        <option>Téléphone</option>
                      </select>
                      </div>
                      <br>             
                      <div class="form-group">
                        <label for="procedure" >Priorité de l'incident</label>
                        <select [(ngModel)]="incident.prioriteIncident"  class="form-select" name="prioriteIncident">
                          <option [ngValue]="undefined">--Sélectionnez une priorité--</option>
                          <option>Critique</option>
                          <option>Haute</option>
                          <option>Moyenne</option>
                          <option>Basse</option>
                        </select>
                        </div>
                      <br>
                      <div class="form-group">
                        <label for="procedure" >Statut de l'incident</label>
                        <select [(ngModel)]="incident.statutIncident"  class="form-select" name="statutIncident">
                          <option [ngValue]="undefined">--Sélectionnez un statut--</option>
                          <option>Attente</option>
                          <option>En_cours</option>
                          <option>Terminé</option>
                        </select>
                        </div>      
                      <br>
                      <div class="form-group">
                        <label>Description de l'incident</label>
                        <textarea class="form-control" type="textarea" name="descriptionIncident" placeholder="Décrivez l'incident" id="descriptionIncident" rows="3" [(ngModel)]="incident.descriptionIncident" ></textarea>
                        <br>
                            <div class="form-group">
                              <label>Date de début de l'incident</label>
                              <input class="form-control" type="datetime-local" name="dateCreationIncident" placeholder="Début incident" id="dateCreationIncident" [(ngModel)]="incident.dateCreationIncident" [min]="minDate" [max]="maxDate">
                            </div>                      
                      <div class="form-group">
                        <label for="agence" class="col-form-label col-sm-2">Agence</label>
                        <select [(ngModel)]="incident.agence"  class="form-control" name="agence">
                          <option [ngValue]="undefined">--Sélectionnez une agence--</option>
                          <option *ngFor="let agence of agences" [ngValue]="agence">{{agence?.lieuAgence}}</option>
                        </select>
                      </div>    
                      <div class="form-group">
                        <label for="procedure" class="col-form-label col-sm-2">Procédure</label>
                        <select [(ngModel)]="incident.procedure"  class="form-control" name="procedure">
                          <option [ngValue]="undefined">--Sélectionnez une procédure--</option>
                          <option *ngFor="let procedure of procedures" [ngValue]="procedure">{{procedure?.nomProcedure}}</option>
                        </select>
                      </div> 
                      <br>
                      <div class="form-group">
                        <label>Date de clôture de l'incident</label>
                        <input class="form-control" type="datetime-local" name="dateClotureIncident" placeholder="Clôture incident" id="dateClotureIncident" [(ngModel)]="incident.dateClotureIncident">
                      </div>
                <div class="col">
                  </div>
                      </div>
                    </div>
                  </div>
                </div>
                    </div>                   
              <div class="modal-footer">
                <button type="button" id="" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                  <button class="btn btn-primary" type="submit">Soumettre</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

   <!--Supprimer un incident-->
   <div class="modal fade" id="deleteIncidentModal" tabindex="-1" aria-labelledby="delete" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fs-5" id="deleteIncidentModal">Suppression incident</h5>
          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer l'incident {{deleteIncident?.nomIncident}} ?</p>     
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Non</button>
          <button type="button" (click)="onDeleteIncident(deleteIncident.idIncident)" class="btn btn-primary" data-dismiss="modal">Oui</button>
        </div>
      </div>
    </div>
  </div>
  </div>